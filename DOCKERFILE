# syntax=docker/dockerfile:1.6

##########################################################
# === Stage 0: Frontend build ===
##########################################################
FROM node:lts-jod AS frontend-build

WORKDIR /app/frontend

# Copy frontend dependencies first (cacheable)
COPY frontend/package.json frontend/yarn.lock ./

# Install frontend dependencies
RUN yarn config set network-timeout 600000 -g \
    && yarn install --frozen-lockfile

# Copy frontend source and build
COPY frontend/ ./
RUN yarn build --outDir dist

##########################################################
# === Stage 1: Backend build ===
##########################################################
FROM python:3.13-slim-bookworm AS backend-build

ARG TARGETARCH
WORKDIR /app

# Install system dependencies needed for Python builds + PostgreSQL
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential libxml2-dev libxslt-dev libffi-dev curl unzip \
    libpq-dev gcc python3-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy backend dependency files (cacheable)
COPY backend/pyproject.toml backend/uv.lock* ./

# Install uv and Python dependencies
RUN curl -LsSf https://github.com/astral-sh/uv/releases/download/0.8.19/uv-installer.sh | sh \
    && export PATH="$HOME/.local/bin:$PATH" \
    && uv sync --locked --no-install-project --no-dev

# Copy backend source
COPY backend/src ./src

# Copy frontend build from frontend stage
COPY --from=frontend-build /app/frontend/dist ./src/frontend/dist

##########################################################
# === Stage 2: Runtime ===
##########################################################
FROM python:3.13-slim-bookworm AS runtime

WORKDIR /app

# Install only runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    libxml2 libxslt1.1 libffi8 curl \
    && rm -rf /var/lib/apt/lists/*

# Copy uv + prebuilt venv from backend build
COPY --from=backend-build /app/.venv /app/.venv
COPY --from=backend-build /root/.local /root/.local

# Copy backend source, frontend dist, and cities.db
COPY --from=backend-build /app/ .

# Environment
ENV PATH="/root/.local/bin:/app/.venv/bin:$PATH"
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Expose port
EXPOSE 8000

# Run FastAPI via uv
CMD ["uv", "run", "uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000"]
