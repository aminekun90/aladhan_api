# syntax=docker/dockerfile:1.6

##########################################################
# === Stage 0: Frontend build ===
##########################################################
FROM node:lts-jod AS frontend-build
WORKDIR /app/frontend
COPY frontend/package.json frontend/yarn.lock ./
RUN yarn config set network-timeout 600000 -g && yarn install --frozen-lockfile
COPY frontend/ ./
RUN yarn build --outDir dist

##########################################################
# === Stage 1: Backend build ===
##########################################################
FROM python:3.13-slim-bookworm AS backend-build

ARG TARGETARCH
WORKDIR /app

RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential libxml2-dev libxslt-dev libffi-dev curl unzip \
    libpq-dev gcc python3-dev \
    && rm -rf /var/lib/apt/lists/*

COPY backend/pyproject.toml backend/uv.lock* ./

RUN curl -LsSf https://github.com/astral-sh/uv/releases/download/0.8.19/uv-installer.sh | sh \
    && export PATH="$HOME/.local/bin:$PATH" \
    && uv sync --locked --no-install-project --no-dev

# --- COPY SOURCE FILES ---
COPY backend/src ./src

# ### <--- NEW: COPY ALEMBIC FILES ###
# Without these, the container cannot run migrations!
COPY backend/alembic ./alembic
COPY backend/alembic.ini .
COPY backend/entrypoint.sh . 
# ####################################

# Copy frontend build from frontend stage
COPY --from=frontend-build /app/frontend/dist ./src/frontend/dist

##########################################################
# === Stage 2: Runtime ===
##########################################################
FROM python:3.13-slim-bookworm AS runtime

WORKDIR /app

RUN apt-get update && apt-get install -y --no-install-recommends \
    libxml2 libxslt1.1 libffi8 curl \
    && rm -rf /var/lib/apt/lists/*

COPY --from=backend-build /app/.venv /app/.venv
COPY --from=backend-build /root/.local /root/.local

COPY --from=backend-build /app/ .


RUN chmod +x entrypoint.sh

# Environment
ENV PATH="/root/.local/bin:/app/.venv/bin:$PATH"
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Expose port
EXPOSE 8000

CMD ["./entrypoint.sh"]