name: Build and Push Adhan API Docker Image

on:
    push:
        branches:
            - main
    release:
        types: [published]

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            # 1️⃣ Checkout the repo
            - name: Checkout code
              uses: actions/checkout@v4

            # 2️⃣ Set up QEMU for ARM emulation
            - name: Set up QEMU
              uses: docker/setup-qemu-action@v3

            # 3️⃣ Set up Docker Buildx (multi-arch build)
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            # 4️⃣ Log in to Docker Hub
            - name: Log in to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKER_USER }}
                  password: ${{ secrets.DOCKER_PASS }}

            # 5️⃣ Get version from pyproject.toml
            - name: Extract version
              id: version
              run: |
                  version=$(grep -Po '(?<=^version = ")[^"]*' pyproject.toml)
                  echo "VERSION=$version" >> $GITHUB_ENV

            # 6️⃣ Build & push multi-arch image
            - name: Build and push Docker image
              run: |
                  docker buildx build \
                    --platform linux/amd64,linux/arm64,linux/arm/v7 \
                    --cache-from=type=registry,ref=aminekun90/adhan-api:cache \
                    --cache-to=type=registry,ref=aminekun90/adhan-api:cache,mode=max \
                    -f Dockerfile \
                    -t aminekun90/adhan-api:latest \
                    -t aminekun90/adhan-api:${VERSION} \
                    --push \
                    .
